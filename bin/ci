#!/usr/bin/env ruby
# frozen_string_literal: true

require_relative "../loader"
require "time"

d = Scheduling::Dispatcher.new
root_strand_id = Prog::Test::HetznerServer.assemble.id
test_start = Time.now

loop do
  if Strand.dataset.where(id: root_strand_id).empty?
    exit 0
  elsif Time.now - test_start > 20 * 60
    puts "Test timed out.  It's considered a failure."
    exit 1
  end

  d.start_cohort
  next if d.wait_cohort > 0
  sleep 5
end
